---
description: 多模型协作规划 - 上下文检索 + 双模型分析 → 生成分步实现计划
---

# 规划命令

多模型协作规划 - 上下文检索 + 双模型分析 → 生成分步实现计划。

$ARGUMENTS

## 核心协议

- **语言协议**：与工具/模型交互时使用**英语**，用用户的语言与用户沟通
- **强制并行**：Codex/Gemini调用必须使用 `run_in_background: true`
- **代码主权**：外部模型**零文件系统写权限**，所有修改由Claude执行
- **止损机制**：当前阶段输出验证前不进入下一阶段
- **仅规划**：此命令允许读取上下文和写入 `.claude/plan/*` 计划文件，但**永不修改生产代码**

## 执行工作流

**规划任务**：$ARGUMENTS

### 阶段1：完整上下文检索

`[模式：研究]`

#### 1.1 提示增强（必须先执行）

**必须调用 `mcp__ace-tool__enhance_prompt` 工具**

等待增强提示，**用增强结果替换原始$ARGUMENTS用于所有后续阶段**。

#### 1.2 上下文检索

**调用 `mcp__ace-tool__search_context` 工具**

- 使用自然语言构建语义查询（哪里/什么/如何）
- **永不基于假设回答**
- 如MCP不可用：回退到Glob + Grep进行文件发现和关键符号定位

#### 1.3 完整性检查

- 必须获取相关类、函数、变量的**完整定义和签名**
- 如上下文不足，触发**递归检索**
- 优先输出：入口文件 + 行号 + 关键符号名称

#### 1.4 需求对齐

- 如需求仍有歧义，**必须**输出引导性问题给用户
- 直到需求边界清晰（无遗漏、无冗余）

### 阶段2：多模型协作分析

`[模式：分析]`

#### 2.1 分发输入

**并行调用** Codex和Gemini（`run_in_background: true`）：

向两个模型分发**原始需求**（不带预设观点）：

1. **Codex后端分析**：
   - ROLE_FILE: `~/.claude/.ccg/prompts/codex/analyzer.md`
   - 关注：技术可行性、架构影响、性能考量、潜在风险
   - 输出：多视角方案 + 优缺点分析

2. **Gemini前端分析**：
   - ROLE_FILE: `~/.claude/.ccg/prompts/gemini/analyzer.md`
   - 关注：UI/UX影响、用户体验、视觉设计
   - 输出：多视角方案 + 优缺点分析

等待两个模型完整结果。**保存SESSION_ID**（`CODEX_SESSION`和`GEMINI_SESSION`）。

#### 2.2 交叉验证

整合视角并迭代优化：

1. **识别共识**（强信号）
2. **识别分歧**（需要权衡）
3. **互补优势**：后端逻辑跟随Codex，前端设计跟随Gemini
4. **逻辑推理**：消除方案中的逻辑漏洞

#### 2.3 生成实现计划

综合两个分析，生成**分步实现计划**：

```markdown
## 实现计划：<任务名称>

### 任务类型
- [ ] 前端（→ Gemini）
- [ ] 后端（→ Codex）
- [ ] 全栈（→ 并行）

### 技术方案
<Codex + Gemini分析综合的最优方案>

### 实现步骤
1. <步骤1> - 预期交付物
2. <步骤2> - 预期交付物
...

### 关键文件
| 文件 | 操作 | 描述 |
|------|------|------|
| path/to/file.ts:L10-L50 | 修改 | 描述 |

### 风险和缓解
| 风险 | 缓解措施 |
|------|----------|

### SESSION_ID（供/ccg:execute使用）
- CODEX_SESSION: <session_id>
- GEMINI_SESSION: <session_id>
```

### 阶段结束：计划交付（非执行）

**`/ccg:plan`职责到此为止，必须执行以下操作**：

1. 向用户呈现完整实现计划（包含伪代码）
2. 保存计划到 `.claude/plan/<功能名称>.md`
3. 用**粗体**输出提示：

   ---
   **计划已生成并保存到 `.claude/plan/actual-feature-name.md`**

   **请审查以上计划。您可以：**
   - **修改计划**：告诉我需要调整的内容，我会更新计划
   - **执行计划**：将以下命令复制到新会话

   ```
   /ccg:execute .claude/plan/actual-feature-name.md
   ```
   ---

4. **立即终止当前响应**（到此为止。不再调用工具。）

**绝对禁止**：
- 问用户"Y/N"然后自动执行（执行是`/ccg:execute`的职责）
- 对生产代码的任何写操作
- 自动调用`/ccg:execute`或任何实现动作

## 关键规则

1. **仅规划，不实现** – 此命令不执行任何代码变更
2. **无Y/N提示** – 只呈现计划，让用户决定后续步骤
3. **信任规则** – 后端跟随Codex，前端跟随Gemini
4. 外部模型**零文件系统写权限**
5. **SESSION_ID传递** – 计划末尾必须包含`CODEX_SESSION`/`GEMINI_SESSION`
