---
description: 重述需求、评估风险并创建分步实现计划。在触碰任何代码前等待用户确认。
---

# 规划命令

此命令调用 **planner** agent 在编写任何代码前创建全面的实现计划。

## 命令功能

1. **重述需求** - 明确需要构建什么
2. **识别风险** - 揭示潜在问题和阻塞因素
3. **创建步骤计划** - 将实现分解为阶段
4. **等待确认** - 必须获得用户批准才能继续

## 使用时机

在以下情况使用 `/plan`：
- 开始新功能
- 进行重大架构变更
- 进行复杂重构
- 会影响多个文件/组件
- 需求不清楚或有歧义

## 工作原理

planner agent 将：

1. **分析请求**并用清晰的术语重述需求
2. **分解为阶段**，包含具体、可操作的步骤
3. **识别依赖**关系
4. **评估风险**和潜在阻塞因素
5. **估算复杂度**（高/中/低）
6. **呈现计划**并等待您的明确确认

## 使用示例

```
用户：/plan 我需要添加市场结算时的实时通知

Agent (planner):
# 实现计划：实时市场结算通知

## 需求重述
- 当用户关注的市场结算时发送通知
- 支持多种通知渠道（应用内、邮件、webhook）
- 确保通知可靠送达
- 包含市场结果和用户持仓结果

## 实现阶段

### 阶段1：数据库模式
- 添加notifications表，字段：id, user_id, market_id, type, status, created_at
- 添加user_notification_preferences表用于渠道偏好
- 在user_id和market_id上创建索引以提高性能

### 阶段2：通知服务
- 在lib/notifications.ts创建通知服务
- 使用BullMQ/Redis实现通知队列
- 添加失败投递的重试逻辑
- 创建通知模板

### 阶段3：集成点
- 在市场结算逻辑中添加钩子（当状态变为"resolved"时）
- 查询所有在市场中有持仓的用户
- 为每个用户入队通知

### 阶段4：前端组件
- 在头部创建NotificationBell组件
- 添加NotificationList模态框
- 通过Supabase订阅实现实时更新
- 添加通知偏好页面

## 依赖
- Redis（用于队列）
- 邮件服务（SendGrid/Resend）
- Supabase实时订阅

## 风险
- 高：邮件送达能力（需要SPF/DKIM）
- 中：每个市场1000+用户时的性能
- 中：市场频繁结算时的通知垃圾信息
- 低：实时订阅开销

## 估算复杂度：中
- 后端：4-6小时
- 前端：3-4小时
- 测试：2-3小时
- 总计：9-13小时

**等待确认**：继续此计划？（是/否/修改）
```

## 重要说明

**关键**：planner agent 在您用"是"、"继续"或类似肯定回复明确确认计划之前，**不会**编写任何代码。

如需变更，请回复：
- "修改：[您的变更]"
- "不同方法：[替代方案]"
- "跳过阶段2，先做阶段3"

## 与其他命令的集成

规划后：
- 使用 `/tdd` 进行测试驱动开发实现
- 如发生构建错误使用 `/build-fix`
- 使用 `/code-review` 审查完成的实现

## 相关Agent

此命令调用位于以下位置的 `planner` agent：
`~/.claude/agents/planner.md`
