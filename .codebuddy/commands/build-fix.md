---
description: 增量修复构建和类型错误，使用最小、安全的变更
---

# 构建修复

增量修复构建和类型错误，使用最小、安全的变更。

## 步骤1：检测构建系统

识别项目的构建工具并运行构建：

| 指示器 | 构建命令 |
|--------|----------|
| `package.json` 有 `build` 脚本 | `npm run build` 或 `pnpm build` |
| `tsconfig.json`（仅TypeScript） | `npx tsc --noEmit` |
| `Cargo.toml` | `cargo build 2>&1` |
| `pom.xml` | `mvn compile` |
| `build.gradle` | `./gradlew compileJava` |
| `go.mod` | `go build ./...` |
| `pyproject.toml` | `python -m py_compile` 或 `mypy .` |

## 步骤2：解析和分组错误

1. 运行构建命令并捕获stderr
2. 按文件路径分组错误
3. 按依赖顺序排序（先修复导入/类型，再修复逻辑错误）
4. 统计总错误数以跟踪进度

## 步骤3：修复循环（一次一个错误）

对每个错误：

1. **读取文件** — 使用Read工具查看错误上下文（错误行前后10行）
2. **诊断** — 确定根本原因（缺少导入、类型错误、语法错误）
3. **最小修复** — 使用Edit工具进行解决错误的最小变更
4. **重新构建** — 验证错误已修复且未引入新错误
5. **继续下一个** — 继续处理剩余错误

## 步骤4：保护措施

遇到以下情况停止并询问用户：
- 修复引入的**错误多于解决的问题**
- **同一错误持续3次**（可能是更深层次的问题）
- 修复需要**架构变更**（不仅仅是构建修复）
- 构建错误源于**缺少依赖**（需要 `npm install`、`cargo add` 等）

## 步骤5：总结

显示结果：
- 已修复的错误（包含文件路径）
- 剩余错误（如有）
- 新引入的错误（应为零）
- 未解决问题的建议后续步骤

## 恢复策略

| 情况 | 操作 |
|------|------|
| 缺少模块/导入 | 检查包是否已安装；建议安装命令 |
| 类型不匹配 | 读取两个类型定义；修复较窄的类型 |
| 循环依赖 | 用导入图识别循环；建议提取 |
| 版本冲突 | 检查 `package.json` / `Cargo.toml` 版本约束 |
| 构建工具配置错误 | 读取配置文件；与正常默认值比较 |

一次修复一个错误以确保安全。优先最小差异而非重构。
