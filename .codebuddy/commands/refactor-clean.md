---
description: 安全识别并删除死代码，每步都有测试验证
---

# 重构清理

安全识别并删除死代码，每步都有测试验证。

## 步骤1：检测死代码

根据项目类型运行分析工具：

| 工具 | 发现内容 | 命令 |
|------|----------|------|
| knip | 未使用的导出、文件、依赖 | `npx knip` |
| depcheck | 未使用的npm依赖 | `npx depcheck` |
| ts-prune | 未使用的TypeScript导出 | `npx ts-prune` |
| vulture | 未使用的Python代码 | `vulture src/` |
| deadcode | 未使用的Go代码 | `deadcode ./...` |
| cargo-udeps | 未使用的Rust依赖 | `cargo +nightly udeps` |

如无可用工具，使用Grep查找零导入的导出：
```
# 查找导出，然后检查是否在任何地方被导入
```

## 步骤2：分类发现

将发现按安全级别排序：

| 级别 | 示例 | 操作 |
|------|------|------|
| **安全** | 未使用的工具函数、测试辅助函数、内部函数 | 自信删除 |
| **谨慎** | 组件、API路由、中间件 | 验证无动态导入或外部消费者 |
| **危险** | 配置文件、入口点、类型定义 | 动手前调查 |

## 步骤3：安全删除循环

对每个安全项：

1. **运行完整测试套件** — 建立基线（全部绿色）
2. **删除死代码** — 使用Edit工具进行精确删除
3. **重新运行测试套件** — 验证没有破坏任何东西
4. **如果测试失败** — 立即用 `git checkout -- <文件>` 恢复并跳过此项
5. **如果测试通过** — 继续下一项

## 步骤4：处理谨慎项

删除谨慎项之前：
- 搜索动态导入：`import()`、`require()`、`__import__`
- 搜索字符串引用：路由名称、配置中的组件名称
- 检查是否从公共包API导出
- 验证无外部消费者（如已发布则检查依赖者）

## 步骤5：合并重复

删除死代码后，寻找：
- 近似重复函数（>80%相似）— 合并为一个
- 冗余类型定义 — 整合
- 无价值的包装函数 — 内联它们
- 无目的的重导出 — 移除间接层

## 步骤6：总结

报告结果：

```
死代码清理
──────────────────────────────
已删除：   12个未使用函数
           3个未使用文件
           5个未使用依赖
已跳过：   2项（测试失败）
节省：     ~450行已移除
──────────────────────────────
所有测试通过 ✅
```

## 规则

- **永远不要在不运行测试的情况下删除**
- **一次删除一个** — 原子变更使回滚更容易
- **不确定就跳过** — 保留死代码比破坏生产更好
- **清理时不要重构** — 分离关注点（先清理，后重构）
